@model IEnumerable<EmployeeViewModel>
@using Employee.MvcClient.Models

@{
	ViewData["Title"] = "EMS";
}

<div class="d-flex justify-content-between align-items-center mb-4">
	<h1>Employee Management System</h1>


</div>

@if (TempData["ErrorMessage"] != null)
{
	<div class="alert alert-danger alert-dismissible fade show" role="alert">
		<strong>Error:</strong> @TempData["ErrorMessage"]
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
}

@if (TempData["SuccessMessage"] != null)
{
	<div class="alert alert-success alert-dismissible fade show" role="alert">
		<strong>Success:</strong> @TempData["SuccessMessage"]
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
}

<div class="container">

	<div class="row">

		<div class="mb-3 col-10">
			<form asp-action="Index" method="get" class="form-inline">
				<div class="input-group">
					<input type="number" name="searchId" class="form-control" placeholder="Search Employee by ID"
						   value="@Context.Request.Query["searchId"]"
						   oninput="if(this.value === '') this.form.submit();" />
					<button type="submit" class="btn btn-primary">Search</button>
				</div>
			</form>
		</div>

		<div class="table-responsive col-10" style="height:500px; overflow-y:scroll">
			<table class="table table-striped table-hover">
				<thead class="table-dark" style="position: sticky; top: 0">
					<tr>
						<th>Employee ID</th>
						<th>First Name</th>
						<th>Last Name</th>
						<th>Email</th>
						<th>Salary (SEK)</th>
						<th>Department ID</th>
						<th>Department Name</th>
						<th>Location</th>
					</tr>
				</thead>
				<tbody>
					@if (Model != null && Model.Any())
					{
						foreach (var employee in Model)
						{
							<tr class="selectable-row" data-employee-id="@employee.EmployeeId">
								<td>@employee.EmployeeId</td>
								<td>@employee.FirstName</td>
								<td>@employee.LastName</td>
								<td>@(employee.Email ?? "N/A")</td>
								<td>@(employee.Salary?.ToString("C") ?? "N/A")</td>
								<td>@employee.DepartmentId</td>
								<td>@employee.Name</td>
								<td>@employee.Location</td>
							</tr>
						}
					}
					else
					{
						<tr>
							<td colspan="8" class="text-center">No employees found</td>
						</tr>
					}
				</tbody>
		</table>
	</div>

		<div class="col-2">
			<div>
				<a asp-controller="Statistics" asp-action="Index" class="btn btn-info w-75 mb-4">
					View statistics
				</a>
			</div>

			<div class="mb-2">
				<a asp-action="Create" class="btn btn-success w-75">Create</a>
			</div>

			<form asp-action="Edit" method="get" class="mb-2">
				<input type="hidden" id="editSelectedId" name="id" />
				<button type="submit" id="editBtn" class="btn btn-warning w-75" disabled>Edit</button>
			</form>

			<form asp-action="Delete" method="get" class="mb-2">
				<input type="hidden" id="deleteSelectedId" name="id" />
				<button type="submit" id="deleteBtn" class="btn btn-danger w-75" disabled>Delete</button>
			</form>

			<div id="selectionWarning" class="alert alert-warning mt-3" style="display: none;" role="alert">
				<small>Please select an employee from the table first.</small>
			</div>
		</div>


</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const rows = document.querySelectorAll("tr.selectable-row");
			const editIdInput = document.getElementById("editSelectedId");
			const deleteIdInput = document.getElementById("deleteSelectedId");
			const editButton = document.getElementById("editBtn");
			const deleteButton = document.getElementById("deleteBtn");
			const selectionWarning = document.getElementById("selectionWarning");

			// Initially disable buttons
			editButton.disabled = true;
			deleteButton.disabled = true;

			rows.forEach(row => {
				row.addEventListener("click", () => {

					rows.forEach(r => r.classList.remove("table-active", "bg-info"));

					row.classList.add("table-active", "bg-info");

					const id = row.dataset.employeeId;
					editIdInput.value = id;
					deleteIdInput.value = id;

					editButton.disabled = false;
					deleteButton.disabled = false;
					
					// Hide warning message when row is selected
					selectionWarning.style.display = 'none';
				});
			});

			// Add form submission validation
			editButton.closest('form').addEventListener('submit', function(e) {
				if (!editIdInput.value) {
					e.preventDefault();
					selectionWarning.style.display = 'block';
					setTimeout(() => {
						selectionWarning.style.display = 'none';
					}, 3000);
				}
			});

			deleteButton.closest('form').addEventListener('submit', function(e) {
				if (!deleteIdInput.value) {
					e.preventDefault();
					selectionWarning.style.display = 'block';
					setTimeout(() => {
						selectionWarning.style.display = 'none';
					}, 3000);
				}
			});
		});
	</script>
}
